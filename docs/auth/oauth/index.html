<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.124.1"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>OAuth | </title><meta name=description content="See the gltf-viewer-app for a working example of OAuth2.

ðŸ“˜ Note
All applications submitted to the Onshape App Store (Onshape Apps) must use OAuth2 â€¦"><meta property="og:title" content="OAuth"><meta property="og:description" content="See the gltf-viewer-app for a working example of OAuth2.
ðŸ“˜ Note
All applications submitted to the Onshape App Store (Onshape Apps) must use OAuth2 for authorization. Automation scripts (or applications not meant for the Onshape App Store) may use either OAuth2 or API Keys for authentication. OAuth2 allows applications to call Onshape APIs on behalf of the users of the application; API keys will only perform operations on behalf of the Onshape user who generated the API keys."><meta property="og:type" content="article"><meta property="og:url" content="https://onshape-public.github.io/docs/auth/oauth/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-05-18T20:39:14-04:00"><meta property="article:modified_time" content="2020-05-18T20:39:14-04:00"><meta itemprop=name content="OAuth"><meta itemprop=description content="See the gltf-viewer-app for a working example of OAuth2.
ðŸ“˜ Note
All applications submitted to the Onshape App Store (Onshape Apps) must use OAuth2 for authorization. Automation scripts (or applications not meant for the Onshape App Store) may use either OAuth2 or API Keys for authentication. OAuth2 allows applications to call Onshape APIs on behalf of the users of the application; API keys will only perform operations on behalf of the Onshape user who generated the API keys."><meta itemprop=datePublished content="2020-05-18T20:39:14-04:00"><meta itemprop=dateModified content="2020-05-18T20:39:14-04:00"><meta itemprop=wordCount content="4184"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="OAuth"><meta name=twitter:description content="See the gltf-viewer-app for a working example of OAuth2.
ðŸ“˜ Note
All applications submitted to the Onshape App Store (Onshape Apps) must use OAuth2 for authorization. Automation scripts (or applications not meant for the Onshape App Store) may use either OAuth2 or API Keys for authentication. OAuth2 allows applications to call Onshape APIs on behalf of the users of the application; API keys will only perform operations on behalf of the Onshape user who generated the API keys."><link rel=preload href=/scss/main.min.edb0fcc3e0fafdc35693077075178413e026f88ce0bcf0304ee6423d78091466.css as=style><link href=/scss/main.min.edb0fcc3e0fafdc35693077075178413e026f88ce0bcf0304ee6423d78091466.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><style>code{white-space:pre-wrap!important;overflow-wrap:break-word}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-3CY8X7Q128"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3CY8X7Q128",{anonymize_ip:!1})}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="95" height="22" viewBox="0 0 95 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.35.0l3.6143 2.09524L3.45714 7.72619V12.5714L0 10.5548V5.44762L9.35.0zm9.4286 16.2643-3.6143 2.1476V7.64763L10.7905 5.08097l3.6666-2.12143 4.3215 2.51428V16.2643zM0 12.3619v3.9809l9.45476 5.4215 4.21664-2.4881L13.6452 15.1381 9.35 17.7048.0 12.3619z" fill="#64bc4f"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4.9762 10.5811 6.57381 11.4978V9.42871L10.9214 6.88824 9.35001 5.91919 4.9762 8.48586V10.5811zm6.8881-3.14291L10.2667 8.35485 12.1 9.42866 12.0738 14.3263 13.6714 13.4096V8.4858L11.8643 7.43819zm-.7072 5.68331v1.781L9.35001 15.9763 4.9762 13.4358V11.6549l4.34762 2.5405 1.83328-1.0739z" fill="#666"/><path fill-rule="evenodd" clip-rule="evenodd" d="M56.5452 3.16919V8.01443C56.8595 7.59538 57.2523 7.2549 57.6976 6.94062 58.1428 6.65252 58.6666 6.49538 59.2428 6.49538s1.0738.07857 1.4929.23571C61.1547 6.88824 61.5214 7.15014 61.8357 7.46443 62.5428 8.17157 62.9095 9.11443 62.9095 10.2668v5.081H61.5999V10.3454C61.5999 9.53348 61.3642 8.9049 60.919 8.43347c-.4452-.47142-1.0476-.70714-1.7548-.70714-.7333.0-1.3619.23572-1.8595.73333C56.7809 8.95728 56.5452 9.58586 56.5452 10.3716v5.0285H55.2357V3.16919h1.3095zM49.7881 7.64775c1.3357.0 2.069.44524 2.1738 1.3619V8.95727h1.3095C53.1928 8.25013 52.9047 7.67394 52.3809 7.25489 51.7786 6.75727 50.9405 6.49537 49.8666 6.49537c-1.1261.0-1.9642.209519999999999-2.5404.65476-.5762.41905-.8643 1.04762-.8643 1.83333C46.4619 9.53346 46.5928 9.92632 46.8809 10.2406 47.169 10.5287 47.5357 10.7644 47.9547 10.9477 48.4 11.1311 48.8714 11.262 49.369 11.3668 49.8928 11.4716 50.3643 11.5763 50.7833 11.7073 51.2024 11.8382 51.569 11.9954 51.8571 12.1787 52.1452 12.3882 52.2762 12.6501 52.2762 13.0168 52.2762 13.5406 51.9881 13.9335 51.4381 14.143L51.3476 14.1703C51.1209 14.2391 50.91 14.3032 50.6786 14.3263 50.4166 14.3525 50.1286 14.3787 49.8405 14.3787S49.2643 14.3525 48.95 14.2477C48.1119 13.9597 47.6666 13.4358 47.5881 12.6239H46.2262C46.2785 13.462 46.619 14.1168 47.2476 14.6406c.680900000000001.5762 1.6238.8643 2.7762.8643 1.1.0 1.9643-.2357 2.5928-.680999999999999C53.2714 14.3787 53.5857 13.7239 53.5857 12.8858 53.5857 12.3358 53.4547 11.9168 53.1667 11.6025 52.8786 11.2882 52.5119 11.0525 52.0928 10.8692 51.6476 10.6858 51.1762 10.5549 50.6786 10.4501 50.2403 10.3844 49.8387 10.282 49.4738 10.1889L49.4734 10.1888 49.4721 10.1885C49.4015 10.1705 49.3322 10.1528 49.2643 10.1358 48.8452 10.0311 48.4785 9.87394 48.1905 9.69061 47.9024 9.50727 47.7714 9.24537 47.7714 8.90489 47.7714 8.0668 48.4524 7.64775 49.7881 7.64775zM30.9309 6.52152c1.3095.0 2.3572.44524 3.1691 1.30952C34.8595 8.66914 35.2523 9.74295 35.2523 11.0263 35.2523 12.3096 34.8595 13.3834 34.1 14.2215 33.2881 15.0858 32.2404 15.531 30.9309 15.531s-2.3571-.4452-3.169-1.3095C27.0023 13.3834 26.6095 12.3096 26.6095 11.0263 26.6095 9.74295 27.0023 8.66914 27.7619 7.83104 28.5738 6.96676 29.6214 6.52152 30.9309 6.52152zm0 7.80478C31.8738 14.3263 32.6071 14.012 33.1571 13.3572 33.6809 12.7287 33.9428 11.9691 33.9428 11.0263 33.9428 10.0834 33.6809 9.29771 33.1571 8.69533 32.6071 8.04057 31.8738 7.72628 30.9309 7.72628 29.9881 7.72628 29.2547 8.04057 28.7047 8.69533 28.1809 9.3239 27.919 10.0834 27.919 11.0263 27.919 11.9691 28.1809 12.7549 28.7047 13.3572 29.2285 14.012 29.9881 14.3263 30.9309 14.3263zm7.3595-7.64764V8.04057C38.6047 7.62152 38.9976 7.28104 39.4428 6.96676 39.8881 6.67866 40.4119 6.52152 40.9881 6.52152c.576099999999997.0 1.0738.07857 1.4928.23571C42.9 6.91438 43.2666 7.17628 43.5809 7.49057 44.2881 8.19771 44.6547 9.14057 44.6547 10.2929v5.081H43.3452V10.3453C43.3452 9.53343 43.1095 8.90485 42.6642 8.43342c-.4452-.47142-1.0476-.70714-1.7547-.70714C40.1761 7.72628 39.5476 7.962 39.05 8.45961 38.5261 8.95723 38.2904 9.58581 38.2904 10.3715v5.0286H36.9809V6.67866h1.3095zM68.7762 15.531C70.1643 15.531 71.1857 15.0072 71.8928 13.9858v1.3881h1.3095V6.65247H71.8928V8.06676C71.1857 7.04533 70.1643 6.52152 68.8547 6.52152 67.5452 6.52152 66.4976 6.96676 65.7119 7.83104 64.9524 8.69533 64.5595 9.76914 64.5595 11.0263c0 1.2833.392899999999997 2.3309 1.1524 3.1952C66.4976 15.0858 67.519 15.531 68.7762 15.531zM71.1857 13.3572C70.6357 14.012 69.9023 14.3263 68.9595 14.3263 68.0166 14.3263 67.2571 14.012 66.7071 13.3572 66.1571 12.7549 65.8952 11.9691 65.8952 11.0263 65.8952 10.0834 66.1571 9.3239 66.7071 8.69533 67.2833 8.04057 68.0428 7.72628 68.9595 7.72628 69.9023 7.72628 70.6357 8.04057 71.1857 8.69533 71.7095 9.29771 71.9714 10.0834 71.9714 11.0263 71.9714 11.9691 71.7095 12.7287 71.1857 13.3572zM76.7643 8.06676C77.4714 7.04533 78.4928 6.52152 79.8809 6.52152c1.2572.0 2.2786.44524 3.0381 1.30952C83.7047 8.69533 84.0976 9.74295 84.0976 11.0263 84.0976 12.2834 83.7047 13.3572 82.919 14.2215 82.1333 15.0858 81.0857 15.531 79.7762 15.531 78.4666 15.531 77.4452 15.0072 76.7381 13.9858v4.8714H75.4285V6.67866h1.3096v1.3881H76.7643zM79.7238 7.70009C78.7809 7.70009 78.0476 8.01438 77.4976 8.66914 76.9738 9.29771 76.7119 10.0572 76.7119 11.0001 76.7119 11.9429 76.9738 12.7287 77.4976 13.331 78.0476 13.9858 78.7809 14.3001 79.7238 14.3001 80.6404 14.3001 81.4 13.9858 81.9762 13.331 82.5262 12.7025 82.7881 11.9429 82.7881 11.0001 82.7881 10.0572 82.5262 9.27152 81.9762 8.66914 81.4 8.04057 80.6404 7.70009 79.7238 7.70009zM92.2167 12.8597C91.719 13.8287 90.8809 14.3263 89.7024 14.3263c-.8643.0-1.5715-.261900000000001-2.1215-.8119C87.0309 12.9906 86.7167 12.3358 86.6119 11.5239H93.919v-.5238C93.919 9.7168 93.5262 8.64299 92.7667 7.80489 91.9548 6.94061 90.9071 6.49537 89.5976 6.49537s-2.3571.44524-3.169 1.30952C85.669 8.64299 85.2762 9.7168 85.2762 11.0001c0 1.2834.392799999999994 2.3572 1.2047 3.1953C87.2929 15.0597 88.3667 15.5049 89.6762 15.5049c1.0476.0 1.8857-.2357 2.54050000000001-.7333C92.8714 14.3001 93.3429 13.6454 93.6571 12.8597H92.2167zM87.5809 8.45965C88.1309 7.96203 88.7857 7.70013 89.5976 7.70013S91.0643 7.96203 91.6143 8.45965C92.1381 8.93108 92.4524 9.55965 92.5571 10.3192H86.6381C86.769 9.55965 87.0571 8.93108 87.5809 8.45965z" fill="#666"/></svg></span><span class=font-weight-bold></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://cad.onshape.com/glassworks/explorer/ target=_blank><span>API Explorer</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://cad.onshape.com target=_blank><span>Onshape</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this siteâ€¦" aria-label="Search this siteâ€¦" autocomplete=off data-offline-search-index-json-src=/offline-search-index.f8bf84470b6c0892ee8f4bfe9f478caa.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this siteâ€¦" aria-label="Search this siteâ€¦" autocomplete=off data-offline-search-index-json-src=/offline-search-index.f8bf84470b6c0892ee8f4bfe9f478caa.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ title="Welcome to the Onshape Developer Documentation" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Welcome</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsapi-intro-li><a href=/docs/api-intro/ title="Introduction to the Onshape REST API" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsapi-intro><span>API Intro</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-introexplorer-li><a href=/docs/api-intro/explorer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-introexplorer><span>API Explorer</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-introarchitecture-li><a href=/docs/api-intro/architecture/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-introarchitecture><span>Architecture</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-introquickstart-li><a href=/docs/api-intro/quickstart/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-introquickstart><span>Quick Start</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-introwhyonshape-li><a href=/docs/api-intro/whyonshape/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-introwhyonshape><span>Why Onshape?</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsauth-li><a href=/docs/auth/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsauth><span>Authentication</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsauthoauth-li><a href=/docs/auth/oauth/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsauthoauth><span class=td-sidebar-nav-active-item>OAuth</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsauthapikeys-li><a href=/docs/auth/apikeys/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsauthapikeys><span>API Keys</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsapi-adv-li><a href=/docs/api-adv/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsapi-adv><span>API Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-advassociativity-li><a href=/docs/api-adv/associativity/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-advassociativity><span>Associativity</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-advbilling-li><a href=/docs/api-adv/billing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-advbilling><span>Billing</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-advconfigs-li><a href=/docs/api-adv/configs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-advconfigs><span>Configurations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-advdrawings-li><a href=/docs/api-adv/drawings/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-advdrawings><span>Drawings</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-advfeatureaccess-li><a href=/docs/api-adv/featureaccess/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-advfeatureaccess><span>Features</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-advtranslation-li><a href=/docs/api-adv/translation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-advtranslation><span>Import & Export</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-advmetadata-li><a href=/docs/api-adv/metadata/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-advmetadata><span>Metadata</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapi-adverrors-li><a href=/docs/api-adv/errors/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapi-adverrors><span>Response Codes</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsapp-dev-li><a href=/docs/app-dev/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsapp-dev><span>App Development</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapp-devextensions-li><a href=/docs/app-dev/extensions/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapp-devextensions><span>Extensions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapp-devclientmessaging-li><a href=/docs/app-dev/clientmessaging/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapp-devclientmessaging><span>Client Messaging</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapp-devstructuredstorage-li><a href=/docs/app-dev/structuredstorage/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapp-devstructuredstorage><span>Structured Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapp-devwebhook-li><a href=/docs/app-dev/webhook/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapp-devwebhook><span>Webhooks</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsapp-store-li><a href=/docs/app-store/ title="Onshape App Store" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsapp-store><span>App Store</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapp-storechecklist-li><a href=/docs/app-store/checklist/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapp-storechecklist><span>Launch Checklist</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapp-storetestingguidelines-li><a href=/docs/app-store/testingguidelines/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapp-storetestingguidelines><span>Testing Guidelines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsapp-storequality-li><a href=/docs/app-store/quality/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsapp-storequality><span>Quality Considerations</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docstutorials-li><a href=/docs/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstutorials><span>Sample Apps</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docstutorialssync-li><a href=/docs/tutorials/sync/ title="Sync Data and Metadata" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialssync><span>Sync Data</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docstutorialsreleases-li><a href=/docs/tutorials/releases/ title="Sync Releases and Revisions" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsreleases><span>Sync Releases</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docstutorialsderivative-li><a href=/docs/tutorials/derivative/ title="Generate Derivative Files" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsderivative><span>Derivative Files</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docstutorialscreateextension-li><a href=/docs/tutorials/createextension/ title="Create an Extension" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialscreateextension><span>Extensions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docstutorialsgltf-li><a href=/docs/tutorials/gltf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsgltf><span>glTF Viewer</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshelp-li><a href=/docs/help/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshelp><span>Get Help</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschangelog-li><a href=/docs/changelog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschangelog><span>Changelog</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#what-is-oauth2>What is OAuth2?</a><ul><li><a href=#oauth2--onshape>OAuth2 & Onshape</a></li><li><a href=#more-resources>More resources</a></li></ul></li><li><a href=#implement-oauth2>Implement OAuth2</a><ul><li><a href=#1-register-the-app>1: Register the app</a></li><li><a href=#2-get-the-user-authorization-code>2: Get the user authorization code</a></li><li><a href=#3-exchange-the-code-for-an-access-token>3: Exchange the code for an access token</a></li><li><a href=#4-use-the-access-token>4: Use the access token</a></li><li><a href=#5-refresh-the-token>5: Refresh the token</a></li><li><a href=#6-grant-authorization>6: Grant authorization</a></li></ul></li><li><a href=#notes>Notes</a><ul><li><a href=#installed-desktop-applications>Installed desktop applications</a></li><li><a href=#enterprise-users>Enterprise users</a></li><li><a href=#3rd-party-cookies>3rd-party cookies</a></li><li><a href=#debugging>Debugging</a></li></ul></li><li><a href=#final-code>Final Code</a><ul><li><a href=#nodejs>Node.js</a></li><li><a href=#python>Python</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://onshape-public.github.io/docs/>Welcome</a></li><li class=breadcrumb-item><a href=https://onshape-public.github.io/docs/auth/>Authentication</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://onshape-public.github.io/docs/auth/oauth/>OAuth</a></li></ol></nav><div class=td-content><h1>OAuth</h1><header class=article-meta></header><p><strong>See the <a href=https://github.com/onshape-public/app-gltf-viewer>gltf-viewer-app</a> for a working example of OAuth2.</strong></p><blockquote><p>ðŸ“˜ <strong>Note</strong></p><p>All applications submitted to the Onshape App Store (Onshape Apps) must use OAuth2 for authorization. Automation scripts (or applications not meant for the Onshape App Store) may use either OAuth2 or <a href=/docs/auth/apikeys>API Keys</a> for authentication. OAuth2 allows applications to call Onshape APIs on behalf of the users of the application; API keys will only perform operations on behalf of the Onshape user who generated the API keys.</p></blockquote><h2 id=what-is-oauth2>What is OAuth2?</h2><p>The OAuth (Open authorization) protocol was developed by the Internet Engineering Task Force, an open standards organization that develops and promotes voluntary Internet standards (particularly the technical standards that comprise the Internet protocol suite) to enable secure, delegated access to an application&rsquo;s resources.</p><p>The OAuth2 protocol enables an application to access a resource that is under the control of someone else. In order to access that resource, a <i>token</i> is required. The token represent the delegated rights of access (that is, what rights this application has, such as read/write/update, scope, rights to different resources, and more).</p><p><i>This means the application can be accessed by a third-party system without that system
impersonating the user that controls the resource.</i></p><p>A good analogy is the hotel check-in process. When you arrive at the front desk of a hotel, you provide an ID and a form of payment. Then, you are given a key card that opens a specific door. When you reach that door, you swipe your key card and are granted access. The door itself doesnâ€™t know who you are or anything about you, it just knows that the key card was encoded correctly, and it allows you access. At some point, the key card expires, and the door no longer lets you into the room. This is the same for access tokens in the OAuth2 flow.</p><p>With the OAuth2 protocol, you register your application with the third party, and you are given a set of keys. These keys get exchanged for an access token that grants you access to resources in the third-party application. The token expires regularly; you miust get a new token to access the application again. For this, you are provided with a <i>refresh token</i>. Sending the refresh token to the authentication server updates your access token and gives you a new refresh token.</p><p><img src=/images/APITokenRequestDiagram.png alt="api token request diagram"></p><h3 id=oauth2--onshape>OAuth2 & Onshape</h3><p>The first step in the OAuth flow is for the Onshape user to request that Onshape let the third-party application access Onshape.</p><p>Once the user has authorized the application, they are redirected to a predefined URL (called a <i>redirect URL</i>) with a code that will requests an access token from Onshape. Therefore, the redirect URL should contain a script that can capture the authorization code.</p><p>You will use the access token to authenticate requests to the Onshape API. The token expires after preset amount of time. To get a new valid access token after one has expired, you must use the refresh token to request a new access token. Refreshing the access token also provides you with an updated refresh token to use in the next refresh access token request. Make sure to store both the the access token and the refresh token, and update them with each refresh of the token. The authorization token must accompany any call to the API, this is done by adding the token to an Authorization field in the header of each request:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>Authorization: Bearer &lt;accessToken&gt;
</span></span></code></pre></div><p>If correctly authenticated, most responses from the REST API call return JSON data (though some return binary data), with an HTTP response code of <code>200 Success</code>, <code>204 - No Content</code>, or <code>301 - Permanent Redirect</code>. <code>301</code> responses will include a redirect for you to follow.</p><p>In the event that the authorization code is incorrect (for instance, if it expired), you will receive an <strong>HTTP 401</strong> response. This response means that the client request has not been completed, since it lacks valid authentication credentials for the requested resource. In this event, your code for each call to the REST API should include a catch clause for a 401 exception. Once caught, you can refresh the token and make the request again. Pay close attention to the <code>Content-Type</code> header for what data to parse and expect.</p><p>When integrating with Onshape, OAuth tokens give third-party applications (such as desktop applications or web services) access to users&rsquo; data as defined by the permissions scope (such as users&rsquo; documents or profile information). Using OAuth terminology, Onshape acts as both the authorization and resource server, while the desktop or web-based application is the client. Resource owners have the option of granting or denying access to applications.</p><p>Once obtained, an OAuth token will work for third-party APIs under <code>/api</code>. Do NOT attempt to use an OAuth token to fetch the URLs typically displayed in a web browsers location bar.</p><h3 id=more-resources>More resources</h3><ul><li><a href=https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2>Digital Ocean</a> - A good resource for learning more about OAuth2.</li><li><a href=http://tools.ietf.org/html/rfc6749>RFC 6749</a> - The reference for the OAuth framework as a whole. Most of this document describes how to implement the OAuth exchanges described by the reference within the context of Onshape and client applications.</li><li><a href=http://tools.ietf.org/html/rfc6750>RFC 6750</a> - Describes the exchange of OAuth access tokens between clients and OAuth servers.</li></ul><h2 id=implement-oauth2>Implement OAuth2</h2><p>This OAuth tutorial demonstrates how to recreate the authentication process in Node.js found in the <a href=https://github.com/onshape-public/app-gltf-viewer>gltf-viewer-app</a> sample code. The <a href=#final-code>final code</a> in Node.js and other languages can be found at the end of this page.</p><h3 id=1-register-the-app>1: Register the app</h3><ol><li>Navigate to <a href=https://dev-portal.onshape.com/signin>https://dev-portal.onshape.com/signin</a> and sign in.</li><li>In the left sidebar, click <strong>OAuth applications</strong>.</li><li>Click the <strong>Create new OAuth application</strong> button.</li><li>Fill out the form as follows:<ul><li>Name: <code>gltf-viewer-yourname</code><ul><li>The application name to display to users.</li><li>Should include the name of your company to differentiate it from other possibly similar applications.</li></ul></li><li>Primary format: <code>com.yourname.gltf-viewer</code><ul><li>String that uniquely identifies your application and is a marker for the data it might store on Onshape servers.</li><li>Cannot be changed after the application is registered.</li></ul></li><li>Summary: <code>Onshape OAuth tutorial</code><ul><li>Description of your application.</li><li>Displayed to the user when theyâ€™re asked to grant the application permission to access their data.</li></ul></li><li>Redirect URLs: <code>http://localhost:5000/token</code><ul><li>Your application must specify at least one URL used in the OAuth protocol exchanges.</li><li>This URL must also use SSL (a URL that begins withÂ https), with two exceptions applicable for
installed desktop applications: <code>http://localhost:&lt;port></code> and <code>urn:ietf:wg:oauth:2.0:oob</code>.</li><li>e.g., <code>https://app-gltf-viewer-yourname-c11f263794bc.herokuapp.com/oauthRedirect</code></li></ul></li><li>Admin team: <code>No Team</code><ul><li>Optional.</li><li>If defined, members of the team can make changes to the definition of this OAuth application.</li><li>See the <a href=https://cad.onshape.com/help/Content/teams-enterprise.htm>Help Docs: Teams</a> page for more information on creating teams in Onshape.</li></ul></li><li>OAuth URL: <code>none</code><ul><li>Should contain the URL of your deployed application.</li><li>This is the first URL called from the Onshape Applications page.</li><li>The page hosted at this URL should handle the OAuth authentication. Once your applicationâ€™s server has been authenticated on behalf of the user, that user should be redirected to your applications content.</li><li>If you have not deployed your app yet, you can leave this field blank (as shown in this example) for local work and update it later.</li><li>e.g., <code>https://app-gltf-viewer-yourname-c11f263794bc.herokuapp.com/oauthSignin</code></li></ul></li><li>Permissions:<ul><li>This is also called application scope, and it defines what access rights your application has to the userâ€™s data.</li><li><strong>Application can read your profile information</strong> - Enable your application to access the Onshape user profile. Check this option.</li><li><strong>Application can read your documents</strong> - Onshape documents created by this user can be accessed with read privileges only. Check this option.</li><li><strong>Application can write to your documents</strong> - The user-owned Onshape documents can be modified by this application. Check this option.</li><li><strong>Application can delete documents and workspaces</strong> - Your application will be able to delete a workspace within a document or the complete Onshape document. Do not check this option for this example.</li><li><strong>Application can request Purchases on Your behalf</strong> - The application will have access to make purchases if required. Do not check this option for this example.</li><li><strong>Application can share and unshare documents on your behalf</strong> - Onshapeâ€™s document sharing capabilities are very powerful; they enable other parties to access your shared documents with
predefined rights. If this option is checked, the application can automatically share a document with other people. Do not check this option for this example.</li></ul></li></ul></li><li>Click <strong>Create application</strong>.</li><li><font style=color:red><b>COPY THE OAUTH SECRET FROM THE POP-UP WINDOW.<b></font><ul><li>You will not be able to access this secret again.</li><li>This secret is unique to you and your app and should be protected like any sensitive password. For example, it should <em>NOT</em> be checked in to source code control systems.</li></ul></li><li>Copy the <strong>OAuth client identifier</strong> from the app Details page that opens.<ul><li>These OAuth secret and client ID keys will be used in your code for requesting a one-time user authorization code from Onshape.</li></ul></li></ol><p>Your application is now registered with Onshape and you have options to
modify the application definition through this portal.</p><img src=/images/devportalappdetails.png alt="the gltf-viewer app in the onshape dev portal app details screen"><h3 id=2-get-the-user-authorization-code>2: Get the user authorization code</h3><p>Weâ€™ll start by loading the basic libraries required to run this sample. We&rsquo;ll use Passport to authenticate requests through plugins known as strategies. In this example, we&rsquo;ll use an Onshape-developed plugin called <code>passport-onshape</code>, but you can define your own strategy to use with Passport, if you prefer. You can find more information on <a href=https://www.npmjs.com/package/passport>Passport here</a>.</p><ol><li>Create a directory for your app, and then install Passport and passport-onshape:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>npm install passport
</span></span><span style=display:flex><span>npm install passport-onshape
</span></span></code></pre></div><ol start=2><li>Next, create a file calls <code>app.js</code> and add the following definitions to the top of the file:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#aaa;font-style:italic>// App definitions 
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#00a>const</span> path = require(<span style=color:#a50>&#39;path&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> uuid = require(<span style=color:#a50>&#39;uuid&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a>const</span> express = require(<span style=color:#a50>&#39;express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> session = require(<span style=color:#a50>&#39;express-session&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> bodyParser = require(<span style=color:#a50>&#39;body-parser&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a>const</span> passport = require(<span style=color:#a50>&#39;passport&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> OnshapeStrategy = require(<span style=color:#a50>&#39;passport-onshape&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a>const</span> config = require(<span style=color:#a50>&#39;./config&#39;</span>);
</span></span></code></pre></div><ol start=3><li>Next, tell Express to use Passport and initialize it. Note: you can replace the Express code with code for the web server of your choice.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#aaa;font-style:italic>// Tell Express to use Passport, and initialize it.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#00a>const</span> app = express();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(express.<span style=color:#00a>static</span>(path.join(__dirname, <span style=color:#a50>&#39;public&#39;</span>)));
</span></span><span style=display:flex><span>app.use(express.<span style=color:#00a>static</span>(path.join(__dirname, <span style=color:#a50>&#39;dist&#39;</span>)));
</span></span><span style=display:flex><span>app.use(bodyParser.json());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.set(<span style=color:#a50>&#39;trust proxy&#39;</span>, <span style=color:#099>1</span>); <span style=color:#aaa;font-style:italic>// To allow to run correctly behind Heroku when deployed
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>
</span></span><span style=display:flex><span>app.use(session({
</span></span><span style=display:flex><span>    secret: config.sessionSecret,
</span></span><span style=display:flex><span>    saveUninitialized: <span style=color:#00a>false</span>,
</span></span><span style=display:flex><span>    resave: <span style=color:#00a>false</span>,
</span></span><span style=display:flex><span>    cookie: {
</span></span><span style=display:flex><span>        name: <span style=color:#a50>&#39;app-gltf-viewer&#39;</span>,
</span></span><span style=display:flex><span>        sameSite: <span style=color:#a50>&#39;none&#39;</span>,
</span></span><span style=display:flex><span>        secure: <span style=color:#00a>true</span>,
</span></span><span style=display:flex><span>        httpOnly: <span style=color:#00a>true</span>,
</span></span><span style=display:flex><span>        path: <span style=color:#a50>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>        maxAge: <span style=color:#099>1000</span> * <span style=color:#099>60</span> * <span style=color:#099>60</span> * <span style=color:#099>24</span> <span style=color:#aaa;font-style:italic>// 1 day
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>    }
</span></span><span style=display:flex><span>}));
</span></span><span style=display:flex><span>app.use(passport.initialize());
</span></span><span style=display:flex><span>app.use(passport.session());
</span></span></code></pre></div><ol start=4><li>Next, we&rsquo;ll store the Onshape user information so it can be retrieved from <code>req.user</code> in
each call. Passport usesÂ the <code>serializeUser</code> function to persist user data (after successful
authentication) into the session. The functionÂ <code>deserializeUser</code> is used
to retrieve user data from session.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Store the Onshape user information
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>passport.serializeUser((user, done) =&gt; done(<span style=color:#00a>null</span>, user));
</span></span><span style=display:flex><span>passport.deserializeUser((obj, done) =&gt; done(<span style=color:#00a>null</span>, obj));
</span></span></code></pre></div><ol start=6><li>Initialize Passport with the Onshape Strategy:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Initialize Passport with the Onshape Strategy
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>passport.use(<span style=color:#00a>new</span> OnshapeStrategy({
</span></span><span style=display:flex><span>        clientID: config.oauthClientId,
</span></span><span style=display:flex><span>        clientSecret: config.oauthClientSecret,
</span></span><span style=display:flex><span>        callbackURL: config.oauthCallbackUrl,
</span></span><span style=display:flex><span>        authorizationURL: <span style=color:#a50>`</span><span style=color:#a50>${</span>config.oauthUrl<span style=color:#a50>}</span><span style=color:#a50>/oauth/authorize`</span>,
</span></span><span style=display:flex><span>        tokenURL: <span style=color:#a50>`</span><span style=color:#a50>${</span>config.oauthUrl<span style=color:#a50>}</span><span style=color:#a50>/oauth/token`</span>,
</span></span><span style=display:flex><span>        userProfileURL: <span style=color:#a50>`</span><span style=color:#a50>${</span>config.oauthUrl<span style=color:#a50>}</span><span style=color:#a50>/api/users/sessioninfo`</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    (accessToken, refreshToken, profile, done) =&gt; {
</span></span><span style=display:flex><span>        profile.accessToken = accessToken;
</span></span><span style=display:flex><span>        profile.refreshToken = refreshToken;
</span></span><span style=display:flex><span>        <span style=color:#00a>return</span> done(<span style=color:#00a>null</span>, profile);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>));
</span></span></code></pre></div><ol start=7><li>Open your environment variables file (e.g.,<code>.env</code>, <code>.bashrc</code>, <code>.bash_profile</code>, <code>.zshrc,</code> etc.) and add the following environment variables, then save and close the file.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>authorizationURL : https://oauth.onshape.com/oauth/authorize
</span></span><span style=display:flex><span>tokenURL : https://oauth.onshape.com/oauth/token
</span></span><span style=display:flex><span>userProfileURL : https://cad.onshape.com/api/users/sessioninfo
</span></span></code></pre></div><p>The callback function will provide us with the <code>accessToken</code>, the <code>refreshToken</code>, and the userâ€™s Onshape profile once authentication has been successfully passed. We can now use this to update our database with user-specific information.</p><p>Note that if you store the <code>accessToken</code> and <code>refreshToken</code> in the database along with the user record, you must update it each time that the access codes are refreshed.</p><ol start=8><li>Next, we define our endpoint where the authorization flow starts (in this case, <code>/oauthSignin</code>). This is the endpoint that we previously defined in the Onshape application setup. This will redirect to an Onshape page in order for the user to confirm (or deny) the applications access to theOnshape resources.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Define the Onshape API endpoint
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>app.use(<span style=color:#a50>&#39;/oauthSignin&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#aaa;font-style:italic>/* These 5 lines are specific to the glTF Viewer sample app. You can replace them with the input for whatever Onshape endpoints you are using in your app */</span>
</span></span><span style=display:flex><span>    <span style=color:#00a>const</span> state = {
</span></span><span style=display:flex><span>        docId: req.query.documentId,
</span></span><span style=display:flex><span>        workId: req.query.workspaceId,
</span></span><span style=display:flex><span>        elId: req.query.elementId
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    req.session.state = state;
</span></span><span style=display:flex><span>    <span style=color:#00a>return</span> passport.authenticate(<span style=color:#a50>&#39;onshape&#39;</span>, { state: uuid.v4(state) })(req, res);
</span></span><span style=display:flex><span>}, (req, res) =&gt; {    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> });
</span></span></code></pre></div><h3 id=3-exchange-the-code-for-an-access-token>3: Exchange the code for an access token</h3><p>Fortunately, if you are using Passport, there isnâ€™t much to do once the user grants authorization. The return URL will contain the one-time authorization token, which Passport will extract and exchange for an access token and a refresh token, which are available in Passport callback function.</p><ol><li>Add the following code to <code>app.js</code>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Exchange the code for an access token
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>app.use(<span style=color:#a50>&#39;/oauthRedirect&#39;</span>, passport.authenticate(<span style=color:#a50>&#39;onshape&#39;</span>, { failureRedirect: <span style=color:#a50>&#39;/grantDenied&#39;</span> }), (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#aaa;font-style:italic>/* This code is specific to the glTF Viewer sample app. You can replace it with the input for whatever Onshape endpoints you are using in your app. */</span>
</span></span><span style=display:flex><span>    res.redirect(<span style=color:#a50>`/?documentId=</span><span style=color:#a50>${</span>req.session.state.docId<span style=color:#a50>}</span><span style=color:#a50>
</span></span></span><span style=display:flex><span><span style=color:#a50>&amp;workspaceId=</span><span style=color:#a50>${</span>req.session.state.workId<span style=color:#a50>}</span><span style=color:#a50>&amp;elementId=
</span></span></span><span style=display:flex><span><span style=color:#a50>    </span><span style=color:#a50>${</span>req.session.state.elId<span style=color:#a50>}</span><span style=color:#a50>`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><ol start=2><li>If the user clicks <strong>Deny</strong> instead of <strong>Authorize Application</strong>, they are taken to a page that notifies them that access to the application was denied. We can see that in the <code>failureRedirect</code> argument. Add the following to <code>app.js</code>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Handle denied access
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>app.get(<span style=color:#a50>&#39;/grantDenied&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    res.sendFile(path.join(__dirname, <span style=color:#a50>&#39;public&#39;</span>, <span style=color:#a50>&#39;html&#39;</span>, <span style=color:#a50>&#39;grantDenied.html&#39;</span>));
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>Now we have received the access token, and it can be accessed from <code>res.user.accessToken</code> on this page or from <code>req.user.accessToken</code> from any other page you redirect to from here.</p><h3 id=4-use-the-access-token>4: Use the access token</h3><ol><li>Add the following to the bottom of <code>app.js</code>. You can see that the access token is used as an Authorization header:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Use the access token as an Authorization header
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>makeOnshapeAPICall: <span style=color:#00a>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#00a>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#00a>const</span> apiUrl = <span style=color:#a50>&#34;https://cad.onshape.com/api/documents?ownerType=1&amp;sortColumn=createdAt&amp;sortOrder=desc&amp;offset=0&amp;limit=20&#34;</span>; <span style=color:#aaa;font-style:italic>//You can replace this with any Onshape API endpoint URL.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            <span style=color:#00a>const</span> resp = <span style=color:#00a>await</span> fetch(normalizedUrl, { headers: { Authorization: <span style=color:#a50>`Bearer </span><span style=color:#a50>${</span>req.user.accessToken<span style=color:#a50>}</span><span style=color:#a50>`</span> }});
</span></span><span style=display:flex><span>            <span style=color:#00a>const</span> data = <span style=color:#00a>await</span> resp.text();
</span></span><span style=display:flex><span>            <span style=color:#00a>const</span> contentType = resp.headers.get(<span style=color:#a50>&#39;Content-Type&#39;</span>);
</span></span><span style=display:flex><span>            res.status(resp.status).contentType(contentType).send(data);
</span></span><span style=display:flex><span>        } <span style=color:#00a>catch</span> (err) {
</span></span><span style=display:flex><span>            res.status(<span style=color:#099>500</span>).json({ error: err });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Note: in the glTF Viewer sample app, this code appears in <code>utils.js</code> instead of <code>app.js</code>.</p><h3 id=5-refresh-the-token>5: Refresh the token</h3><p>When the access token expires, it must be refreshed by making another <code>POST</code> request toÂ <code>https://oauth.onshape.com/oauth/token</code>Â with the following URL-encoded form body (with <code>Content-TypeÂ application/x-www-form-urlencoded</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a00>grant_type</span>=refresh_token&amp;<span style=color:#a00>refresh_token</span>=<span style=color:#a50>\&lt;</span>refresh_token<span style=color:#a50>\&gt;</span>&amp;<span style=color:#a00>client_id</span>=<span style=color:#a50>\&lt;</span>client_id<span style=color:#a50>\&gt;</span>&amp;<span style=color:#a00>client_secret</span>=<span style=color:#a50>\&lt;</span>client_secret<span style=color:#a50>\&gt;</span>
</span></span></code></pre></div><p>As with the authorization code data, the parameters in the form body must be URL-encoded. The response to this <code>POST</code> request will be a JSON-encoded structure with a newÂ <code>access_token</code>Â value that can be used for the next 60 minutes.</p><p>Refresh tokens are valid for the lifetime of the userâ€™s grant. If a user who previously granted access to your application decides to revoke the grant, the refresh token is invalidated. If the user decides to re-grant application access, a new refresh token is generated and returned along with the access token.</p><ol><li>Add the following to <code>app.js</code>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#aaa;font-style:italic>/** After landing on the home page, we check if a user had already signed in. If no user has signed in, we redirect the request to the OAuth sign-in page. If a user had signed in previously, we will attempt to refresh the access token of the user. After successfully refreshing the access token, we will simply take the user to the landing page of the app. If the refresh token request fails, we will redirect the user to the OAuth sign-in page again. */</span>
</span></span><span style=display:flex><span>app.get(<span style=color:#a50>&#39;/&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#00a>if</span> (!req.user) {
</span></span><span style=display:flex><span>        <span style=color:#00a>return</span> res.redirect(<span style=color:#a50>`/oauthSignin</span><span style=color:#a50>${</span>req._parsedUrl.search ? req._parsedUrl.search : <span style=color:#a50>&#34;&#34;</span><span style=color:#a50>}</span><span style=color:#a50>`</span>);
</span></span><span style=display:flex><span>    } <span style=color:#00a>else</span> {
</span></span><span style=display:flex><span>        refreshAccessToken(req.user).then((tokenJson) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#aaa;font-style:italic>// Dereference the user object and update the access token and refresh token in the in-memory object.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            <span style=color:#00a>let</span> usrObj = JSON.parse(JSON.stringify(req.user));
</span></span><span style=display:flex><span>            usrObj.accessToken = tokenJson.access_token;
</span></span><span style=display:flex><span>            usrObj.refreshToken = tokenJson.refresh_token;
</span></span><span style=display:flex><span>            <span style=color:#aaa;font-style:italic>// Update the user object in PassportJS. No redirections will happen here, this is a purely internal operation.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            req.login(usrObj, () =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#00a>return</span> res.sendFile(path.join(__dirname, <span style=color:#a50>&#39;public&#39;</span>, <span style=color:#a50>&#39;html&#39;</span>, <span style=color:#a50>&#39;index.html&#39;</span>));
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }).<span style=color:#00a>catch</span>(() =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#aaa;font-style:italic>// Refresh token failed, take the user to OAuth sign in page.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            <span style=color:#00a>return</span> res.redirect(<span style=color:#a50>`/oauthSignin</span><span style=color:#a50>${</span>req._parsedUrl.search ? req._parsedUrl.search : <span style=color:#a50>&#34;&#34;</span><span style=color:#a50>}</span><span style=color:#a50>`</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Refresh the access token
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#00a>const</span> refreshAccessToken = <span style=color:#00a>async</span> (user) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#00a>const</span> body = <span style=color:#a50>&#39;grant_type=refresh_token&amp;refresh_token=&#39;</span> + user.refreshToken + <span style=color:#a50>&#39;&amp;client_id=&#39;</span> + config.oauthClientId + <span style=color:#a50>&#39;&amp;client_secret=&#39;</span> + config.oauthClientSecret;
</span></span><span style=display:flex><span>    <span style=color:#00a>let</span> res = <span style=color:#00a>await</span> fetch(config.oauthUrl + <span style=color:#a50>&#34;/oauth/token&#34;</span>, {
</span></span><span style=display:flex><span>        method: <span style=color:#a50>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>        headers: {
</span></span><span style=display:flex><span>            <span style=color:#a50>&#39;Content-Type&#39;</span>: <span style=color:#a50>&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        body: body
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#00a>if</span> (res.ok) {
</span></span><span style=display:flex><span>        <span style=color:#00a>return</span> <span style=color:#00a>await</span> res.json();
</span></span><span style=display:flex><span>    } <span style=color:#00a>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#00a>throw</span> <span style=color:#00a>new</span> <span style=color:#0aa>Error</span>(<span style=color:#a50>&#34;Could not refresh access token, please sign in again.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(<span style=color:#a50>&#39;/api&#39;</span>, require(<span style=color:#a50>&#39;./api&#39;</span>));
</span></span><span style=display:flex><span>module.exports = app;
</span></span></code></pre></div><ol start=2><li>Save the file.</li><li>To see the authentication working in practice, you can follow the instructions in the <a href=https://github.com/onshape-public/app-gltf-viewer#readme>glTF Viewer README</a> to deploy the glTF Viewer app.</li></ol><h3 id=6-grant-authorization>6: Grant authorization</h3><p>For apps published in the Onshape App Store, the Onshape user must grant authorization to your application to access the Onshape data. This must be done by each user of your app.</p><p>To grant the application access to a user&rsquo;s data in Onshape, the <em>Onshape user</em> must follow the steps below:</p><ol><li>Sign in to <code>cad.onshape.com</code>.<ul><li>Note: Use <code>https://companyName.onshape.com</code> for Enterprise accounts. See <a href=#enterprise-users>Enterprise users</a> below for more information.</li></ul></li><li>Click their name in the top-right corner of the Onshape window, and then click <strong>My account</strong> in the dropdown menu.</br><img src=/images/myaccountdropdown.png alt=drawing width=300></li><li>Click <strong>Applications</strong> in the left sidebar.<ul><li>Note that the gltf-viewer app will not appear in this list until it has been deployed and subscribed to as described in the <a href=https://github.com/onshape-public/app-gltf-viewer#readme>glTF Viewer README</a>.</li></ul></li><li>Click <strong>Grant</strong> next to your app name to grant it access to their Onshape data. The Onshape user can click <strong>Revoke</strong> at any time to prevent your app from accessing their Onshape data.</li><li>The user will see the Authorize application screen shown below and will need to confirm their authorization grant by clicking <strong>Authorize application</strong>. The user is then redirected to the Redirect URL you specified in your code. Your app can now access the user&rsquo;s Onshape resources and profile.</li></ol><h2 id=notes>Notes</h2><h3 id=installed-desktop-applications>Installed desktop applications</h3><p>OAuth is designed for interactions between two servers using a browser. However, it can also be used by an installed desktop (or mobile) application. The application must perform a similar role to that of a third party server: it must exchange the code for an access token structure.</p><p>To enable this, Onshape allows two special forms of redirect URI to be registered:</p><ul><li><code>http://localhost:&lt;port></code> Causes the browser to attempt to load a page from the host upon which it is running. The code parameter will be supplied exactly the same as outlined above. If the application can listen on the registered port and behave as a simple web server for the redirect URL, it can retrieve the code in the same way as a deployed web server.</li><li><code>urn:ietf:wg:oauth:2.0:oob</code> Causes the browser to display a simple page after a request has been granted instead of going to a new URL. The page contains simple instructions to copy and paste code into an application field. The browser will also update the title of the window to contain the code. An application could also look for browsers with window titles containing the string <code>Success code=&lt;code></code> and automatically grab the code from the browser window title. If an error occurs (e.g., the grant is denied), the browser window title will contain <code>Error description=&lt;error string></code>.</li></ul><h3 id=enterprise-users>Enterprise users</h3><p>When a user authorizes an OAuth app to access Onshape on their behalf, they get a bearer token that corresponds to their session and the allowed scopes.</p><p>However, if the user has a seat in the Enterprise, additional information is needed to determine whether to allow the bearer token to access enterprise data for the user or simply return non-enterprise data. We use the <code>companyId</code> field for this distinction.</p><p>There are two ways of setting the <code>companyId</code> correctly to access enterprise data:</p><ul><li>During the authorization process, select the name and URL of the enterprise instead of <code>cad.onshape.com</code>. This will correctly associate your bearer token with the <code>companyId</code>.</li><li>If you have an integrated app, call the <a href=https://cad.onshape.com/glassworks/explorer/#/Company/findCompany>Company/findCompany</a> endpoint to obtain the <code>companyId</code>. Append this <code>companyId</code> as a query parameter to the <code>/authorize</code> URL while initiating the OAuth workflow. (Note: you may be asked to authenticate yourself again.)</li></ul><h3 id=3rd-party-cookies>3rd-party cookies</h3><p>3rd-party cookies must be enabled in the browser for Onshape apps to work correctly.</p><h3 id=debugging>Debugging</h3><p>Debugging OAuth can be a little tricky. Some tips are below:</p><ol><li>Make sure you are correctly URL encoding the values supplied to the oauth/authorize and oauth/token endpoints.</li><li>Use a <code>GET /oauth/authorize</code> but a <code>POST /oauth/token</code> and make sure that the GET uses query parameters but that the <code>POST</code> uses a URL-encoded form body.</li><li>If you supply a <code>redirect_uri</code> to <code>/oauth/authorize</code>, you must also supply it as an additional parameter in the <code>POST</code> to <code>/oauth/token</code></li><li>Use a tool such as <a href=https://portswigger.net/burp>Burp</a> or <a href=http://charlesproxy.com>Charles</a> to deliberately &lsquo;man-in-the-middle&rsquo; the connection requests between your server and Onshape, and verify that you are performing the correct REST operations (GET vs. POST) and correctly URL-encoding the parameter values.</li></ol><h2 id=final-code>Final Code</h2><p>The above example uses Node.js to authenticate an Onshape app. This section includes the code for using OAuth2 with other coding languages.</p><h3 id=nodejs>Node.js</h3><p><strong>Prerequisites</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install passport
</span></span><span style=display:flex><span>npm install passport-onshape
</span></span></code></pre></div><p><strong>Environment variables</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>authorizationURL : &lt;https://oauth.onshape.com/oauth/authorize&gt;
</span></span><span style=display:flex><span>tokenURL : &lt;https://oauth.onshape.com/oauth/token&gt;
</span></span><span style=display:flex><span>userProfileURL : &lt;https://cad.onshape.com/api/users/sessioninfo&gt;
</span></span></code></pre></div><p><strong>app.js</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#aaa;font-style:italic>//App definitions
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#00a>const</span> path = require(<span style=color:#a50>&#39;path&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> uuid = require(<span style=color:#a50>&#39;uuid&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a>const</span> express = require(<span style=color:#a50>&#39;express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> session = require(<span style=color:#a50>&#39;express-session&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> bodyParser = require(<span style=color:#a50>&#39;body-parser&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a>const</span> passport = require(<span style=color:#a50>&#39;passport&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#00a>const</span> OnshapeStrategy = require(<span style=color:#a50>&#39;passport-onshape&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a>const</span> config = require(<span style=color:#a50>&#39;./config&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Tell Express to use Passport, and initialize it.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#00a>const</span> app = express();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(express.<span style=color:#00a>static</span>(path.join(__dirname, <span style=color:#a50>&#39;public&#39;</span>)));
</span></span><span style=display:flex><span>app.use(express.<span style=color:#00a>static</span>(path.join(__dirname, <span style=color:#a50>&#39;dist&#39;</span>)));
</span></span><span style=display:flex><span>app.use(bodyParser.json());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.set(<span style=color:#a50>&#39;trust proxy&#39;</span>, <span style=color:#099>1</span>); <span style=color:#aaa;font-style:italic>// To allow to run correctly behind Heroku when deployed.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>
</span></span><span style=display:flex><span>app.use(session({
</span></span><span style=display:flex><span>    secret: config.sessionSecret,
</span></span><span style=display:flex><span>    saveUninitialized: <span style=color:#00a>false</span>,
</span></span><span style=display:flex><span>    resave: <span style=color:#00a>false</span>,
</span></span><span style=display:flex><span>    cookie: {
</span></span><span style=display:flex><span>        name: <span style=color:#a50>&#39;app-gltf-viewer&#39;</span>,
</span></span><span style=display:flex><span>        sameSite: <span style=color:#a50>&#39;none&#39;</span>,
</span></span><span style=display:flex><span>        secure: <span style=color:#00a>true</span>,
</span></span><span style=display:flex><span>        httpOnly: <span style=color:#00a>true</span>,
</span></span><span style=display:flex><span>        path: <span style=color:#a50>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>        maxAge: <span style=color:#099>1000</span> * <span style=color:#099>60</span> * <span style=color:#099>60</span> * <span style=color:#099>24</span> <span style=color:#aaa;font-style:italic>// 1 day
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>    }
</span></span><span style=display:flex><span>}));
</span></span><span style=display:flex><span>app.use(passport.initialize());
</span></span><span style=display:flex><span>app.use(passport.session());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Store the Onshape user information
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>passport.serializeUser((user, done) =&gt; done(<span style=color:#00a>null</span>, user));
</span></span><span style=display:flex><span>passport.deserializeUser((obj, done) =&gt; done(<span style=color:#00a>null</span>, obj));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Initialize Passport with the Onshape Strategy
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>passport.use(<span style=color:#00a>new</span> OnshapeStrategy({
</span></span><span style=display:flex><span>        clientID: config.oauthClientId,
</span></span><span style=display:flex><span>        clientSecret: config.oauthClientSecret,
</span></span><span style=display:flex><span>        callbackURL: config.oauthCallbackUrl,
</span></span><span style=display:flex><span>        authorizationURL: <span style=color:#a50>`</span><span style=color:#a50>${</span>config.oauthUrl<span style=color:#a50>}</span><span style=color:#a50>/oauth/authorize`</span>,
</span></span><span style=display:flex><span>        tokenURL: <span style=color:#a50>`</span><span style=color:#a50>${</span>config.oauthUrl<span style=color:#a50>}</span><span style=color:#a50>/oauth/token`</span>,
</span></span><span style=display:flex><span>        userProfileURL: <span style=color:#a50>`</span><span style=color:#a50>${</span>config.oauthUrl<span style=color:#a50>}</span><span style=color:#a50>/api/users/sessioninfo`</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    (accessToken, refreshToken, profile, done) =&gt; {
</span></span><span style=display:flex><span>        profile.accessToken = accessToken;
</span></span><span style=display:flex><span>        profile.refreshToken = refreshToken;
</span></span><span style=display:flex><span>        <span style=color:#00a>return</span> done(<span style=color:#00a>null</span>, profile);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Define the Onshape API endpoint
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>app.use(<span style=color:#a50>&#39;/oauthSignin&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#aaa;font-style:italic>/* These 5 lines are specific to the glTF Viewer sample app. You can replace them with the input for whatever Onshape endpoints you are using in your app. */</span>
</span></span><span style=display:flex><span>    <span style=color:#00a>const</span> state = {
</span></span><span style=display:flex><span>        docId: req.query.documentId,
</span></span><span style=display:flex><span>        workId: req.query.workspaceId,
</span></span><span style=display:flex><span>        elId: req.query.elementId
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    req.session.state = state;
</span></span><span style=display:flex><span>    <span style=color:#00a>return</span> passport.authenticate(<span style=color:#a50>&#39;onshape&#39;</span>, { state: uuid.v4(state) })(req, res);
</span></span><span style=display:flex><span>}, (req, res) =&gt; {    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(<span style=color:#a50>&#39;/oauthRedirect&#39;</span>, passport.authenticate(<span style=color:#a50>&#39;onshape&#39;</span>, { failureRedirect: <span style=color:#a50>&#39;/grantDenied&#39;</span> }), (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#aaa;font-style:italic>/* This code is specific to the glTF Viewer sample app. You can replace it with the input for whatever Onshape endpoints you are using in your app. */</span>
</span></span><span style=display:flex><span>    res.redirect(<span style=color:#a50>`/?documentId=</span><span style=color:#a50>${</span>req.session.state.docId<span style=color:#a50>}</span><span style=color:#a50>&amp;workspaceId=</span><span style=color:#a50>${</span>req.session.state.workId<span style=color:#a50>}</span><span style=color:#a50>&amp;elementId=</span><span style=color:#a50>${</span>req.session.state.elId<span style=color:#a50>}</span><span style=color:#a50>`</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Handle denied access
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>app.get(<span style=color:#a50>&#39;/grantDenied&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    res.sendFile(path.join(__dirname, <span style=color:#a50>&#39;public&#39;</span>, <span style=color:#a50>&#39;html&#39;</span>, <span style=color:#a50>&#39;grantDenied.html&#39;</span>));
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>/** After landing on the home page, we check if a user had already signed in. If no user has signed in, we redirect the request to the OAuth sign-in page. If a user had signed in previously, we will attempt to refresh the access token of the user. After successfully refreshing the access token, we will simply take the user to the landing page of the app. If the refresh token request fails, we will redirect the user to the OAuth sign-in page again. */</span>
</span></span><span style=display:flex><span>app.get(<span style=color:#a50>&#39;/&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#00a>if</span> (!req.user) {
</span></span><span style=display:flex><span>        <span style=color:#00a>return</span> res.redirect(<span style=color:#a50>`/oauthSignin</span><span style=color:#a50>${</span>req._parsedUrl.search ? req._parsedUrl.search : <span style=color:#a50>&#34;&#34;</span><span style=color:#a50>}</span><span style=color:#a50>`</span>);
</span></span><span style=display:flex><span>    } <span style=color:#00a>else</span> {
</span></span><span style=display:flex><span>        refreshAccessToken(req.user).then((tokenJson) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#aaa;font-style:italic>// Dereference the user object, and update the access token and refresh token in the in-memory object.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            <span style=color:#00a>let</span> usrObj = JSON.parse(JSON.stringify(req.user));
</span></span><span style=display:flex><span>            usrObj.accessToken = tokenJson.access_token;
</span></span><span style=display:flex><span>            usrObj.refreshToken = tokenJson.refresh_token;
</span></span><span style=display:flex><span>            <span style=color:#aaa;font-style:italic>// Update the user object in PassportJS. No redirections will happen here, this is a purely internal operation.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            req.login(usrObj, () =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#00a>return</span> res.sendFile(path.join(__dirname, <span style=color:#a50>&#39;public&#39;</span>, <span style=color:#a50>&#39;html&#39;</span>, <span style=color:#a50>&#39;index.html&#39;</span>));
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }).<span style=color:#00a>catch</span>(() =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#aaa;font-style:italic>// Refresh token failed, take the user to OAuth sign in page.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            <span style=color:#00a>return</span> res.redirect(<span style=color:#a50>`/oauthSignin</span><span style=color:#a50>${</span>req._parsedUrl.search ? req._parsedUrl.search : <span style=color:#a50>&#34;&#34;</span><span style=color:#a50>}</span><span style=color:#a50>`</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Refresh the access token
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#00a>const</span> refreshAccessToken = <span style=color:#00a>async</span> (user) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#00a>const</span> body = <span style=color:#a50>&#39;grant_type=refresh_token&amp;refresh_token=&#39;</span> + user.refreshToken + <span style=color:#a50>&#39;&amp;client_id=&#39;</span> + config.oauthClientId + <span style=color:#a50>&#39;&amp;client_secret=&#39;</span> + config.oauthClientSecret;
</span></span><span style=display:flex><span>    <span style=color:#00a>let</span> res = <span style=color:#00a>await</span> fetch(config.oauthUrl + <span style=color:#a50>&#34;/oauth/token&#34;</span>, {
</span></span><span style=display:flex><span>        method: <span style=color:#a50>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>        headers: {
</span></span><span style=display:flex><span>            <span style=color:#a50>&#39;Content-Type&#39;</span>: <span style=color:#a50>&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        body: body
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#00a>if</span> (res.ok) {
</span></span><span style=display:flex><span>        <span style=color:#00a>return</span> <span style=color:#00a>await</span> res.json();
</span></span><span style=display:flex><span>    } <span style=color:#00a>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#00a>throw</span> <span style=color:#00a>new</span> <span style=color:#0aa>Error</span>(<span style=color:#a50>&#34;Could not refresh access token, please sign in again.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(<span style=color:#a50>&#39;/api&#39;</span>, require(<span style=color:#a50>&#39;./api&#39;</span>));
</span></span><span style=display:flex><span>module.exports = app;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic>//Use the access token in an Authorization header.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>makeOnshapeAPICall: <span style=color:#00a>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#00a>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#00a>const</span> apiUrl = <span style=color:#a50>&#34;https://cad.onshape.com/glassworks/explorer/#/Document/getDocuments&#34;</span>; <span style=color:#aaa;font-style:italic>//You can replace this with any Onshape API endpoint URL.
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span>            <span style=color:#00a>const</span> resp = <span style=color:#00a>await</span> fetch(normalizedUrl, { headers: { Authorization: <span style=color:#a50>`Bearer </span><span style=color:#a50>${</span>req.user.accessToken<span style=color:#a50>}</span><span style=color:#a50>`</span> }});
</span></span><span style=display:flex><span>            <span style=color:#00a>const</span> data = <span style=color:#00a>await</span> resp.text();
</span></span><span style=display:flex><span>            <span style=color:#00a>const</span> contentType = resp.headers.get(<span style=color:#a50>&#39;Content-Type&#39;</span>);
</span></span><span style=display:flex><span>            res.status(resp.status).contentType(contentType).send(data);
</span></span><span style=display:flex><span>        } <span style=color:#00a>catch</span> (err) {
</span></span><span style=display:flex><span>            res.status(<span style=color:#099>500</span>).json({ error: err });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=python>Python</h3><p>This Python code only works on a local machine. To deploy the code, you can replace the Flask code with the web server of your choice.</p><p><strong>Prerequisites</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install flask
</span></span><span style=display:flex><span>pip3 install requests_oauthlib
</span></span></code></pre></div><p><strong>app.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#00a>from</span> <span style=color:#0aa;text-decoration:underline>flask</span> <span style=color:#00a>import</span> Flask, request, redirect, session, url_for
</span></span><span style=display:flex><span><span style=color:#00a>from</span> <span style=color:#0aa;text-decoration:underline>flask.json</span> <span style=color:#00a>import</span> jsonify
</span></span><span style=display:flex><span><span style=color:#00a>from</span> <span style=color:#0aa;text-decoration:underline>requests_oauthlib</span> <span style=color:#00a>import</span> OAuth2Session
</span></span><span style=display:flex><span><span style=color:#00a>import</span> <span style=color:#0aa;text-decoration:underline>os</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app = Flask(__name__)
</span></span><span style=display:flex><span>app.secret_key = <span style=color:#a50>b</span><span style=color:#a50>&#39;F</span><span style=color:#a50>\xf5\xe5\xc0\xbe\t</span><span style=color:#a50>g</span><span style=color:#a50>\x7f\xac\x89\x87</span><span style=color:#a50>e</span><span style=color:#a50>\xc2</span><span style=color:#a50>4</span><span style=color:#a50>\xe8</span><span style=color:#a50>m</span><span style=color:#a50>\x1c\xd9\xda\x96</span><span style=color:#a50>G,</span><span style=color:#a50>\x90</span><span style=color:#a50>i&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os.environ[<span style=color:#a50>&#39;OAUTHLIB_INSECURE_TRANSPORT&#39;</span>] = <span style=color:#a50>&#34;1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client_id = &lt;Client ID of your application&gt;
</span></span><span style=display:flex><span>client_secret = &lt;Client Secret of your application&gt;
</span></span><span style=display:flex><span>authorization_base_url = <span style=color:#a50>&#34;https://oauth.onshape.com/oauth/authorize&#34;</span>
</span></span><span style=display:flex><span>token_url = <span style=color:#a50>&#34;https://oauth.onshape.com/oauth/token&#34;</span>
</span></span><span style=display:flex><span>redirect_url = <span style=color:#a50>&#34;http://localhost:5000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>@app.route</span>(<span style=color:#a50>&#39;/&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#00a>def</span> <span style=color:#0a0>home</span>():
</span></span><span style=display:flex><span>  onshape = OAuth2Session(client_id, redirect_uri=redirect_url)
</span></span><span style=display:flex><span>  auth_url, state = onshape.authorization_url(authorization_base_url)
</span></span><span style=display:flex><span>  session[<span style=color:#a50>&#39;oauth_state&#39;</span>] = state
</span></span><span style=display:flex><span>  <span style=color:#00a>return</span> redirect(auth_url)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>@app.route</span>(<span style=color:#a50>&#39;/token&#39;</span>, methods=[<span style=color:#a50>&#34;GET&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#00a>def</span> <span style=color:#0a0>token</span>():
</span></span><span style=display:flex><span>  onshape = OAuth2Session(client_id, state=session[<span style=color:#a50>&#39;oauth_state&#39;</span>], redirect_uri=redirect_url)
</span></span><span style=display:flex><span>  token = onshape.fetch_token(token_url, client_secret=client_secret, authorization_response=request.url)
</span></span><span style=display:flex><span>  session[<span style=color:#a50>&#39;oauth_token&#39;</span>] = token
</span></span><span style=display:flex><span>  <span style=color:#00a>return</span> redirect(url_for(<span style=color:#a50>&#39;.documents&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>@app.route</span>(<span style=color:#a50>&#39;/documents&#39;</span>, methods=[<span style=color:#a50>&#34;GET&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#00a>def</span> <span style=color:#0a0>documents</span>():
</span></span><span style=display:flex><span>  extra = {
</span></span><span style=display:flex><span>    <span style=color:#a50>&#39;client_id&#39;</span>: client_id,
</span></span><span style=display:flex><span>    <span style=color:#a50>&#39;client_secret&#39;</span>: client_secret,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  onshape = OAuth2Session(client_id, token=session[<span style=color:#a50>&#39;oauth_token&#39;</span>], redirect_uri=redirect_url)
</span></span><span style=display:flex><span>  session[<span style=color:#a50>&#39;oauth_token&#39;</span>] = onshape.refresh_token(token_url, **extra)
</span></span><span style=display:flex><span>  <span style=color:#00a>return</span> jsonify(onshape.get(<span style=color:#a50>&#39;https://cad.onshape.com/api/v6/documents?q=Untitled&amp;ownerType=1&amp;sortColumn=createdAt&amp;sortOrder=desc&amp;offset=0&amp;limit=20&#39;</span>).json())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a>if</span> __name__ == <span style=color:#a50>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>  app.run()
</span></span><span style=display:flex><span>  
</span></span></code></pre></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/main.min.a8aca58be32dafbc1f83ea37498f84156385fd2ded5d1776c98a24db210d3ec6.js integrity="sha256-qKyli+Mtr7wfg+o3SY+EFWOF/S3tXRd2yYok2yENPsY=" crossorigin=anonymous></script></body></html>